<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Reachy Dance Duo - Pollen Robotics</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
		rel="stylesheet">
	<style>
		:root {
			--primary: #FF9900;
			--primary-glow: rgba(255, 153, 0, 0.4);
			--dark-bg: #0A0A0A;
			--card-bg: #141414;
			--text-main: #FFFFFF;
			--text-dim: #A0A0A0;
			--accent-blue: #00D1FF;
		}

		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		body {
			font-family: 'Outfit', sans-serif;
			background-color: var(--dark-bg);
			color: var(--text-main);
			line-height: 1.6;
			overflow-x: hidden;
		}

		/* --- Hero Section & 3D Canvas --- */
		.hero {
			position: relative;
			height: 80vh;
			display: flex;
			align-items: center;
			justify-content: center;
			text-align: center;
			padding: 2rem;
			overflow: hidden;
		}

		#visualizer-container {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: 0;
			opacity: 0.6;
		}

		.hero-content {
			max-width: 800px;
			z-index: 1;
			pointer-events: none;
			/* Allow interaction with canvas below if needed */
		}

		.hero-emoji {
			font-size: 4rem;
			margin-bottom: 1rem;
			display: block;
			animation: bounce 2s infinite;
		}

		@keyframes bounce {

			0%,
			100% {
				transform: translateY(0);
			}

			50% {
				transform: translateY(-10px);
			}
		}

		.hero h1 {
			font-size: 4rem;
			font-weight: 800;
			margin-bottom: 1rem;
			background: linear-gradient(90deg, #FFFFFF, var(--primary));
			-webkit-background-clip: text;
			background-clip: text;
			-webkit-text-fill-color: transparent;
			letter-spacing: -1px;
		}

		.hero p {
			font-size: 1.5rem;
			color: var(--text-dim);
			margin-bottom: 2rem;
			font-weight: 300;
		}

		.tags {
			display: flex;
			gap: 0.5rem;
			justify-content: center;
			flex-wrap: wrap;
			margin-bottom: 2rem;
		}

		.tag {
			background: rgba(255, 255, 255, 0.1);
			padding: 0.4rem 1rem;
			border-radius: 20px;
			font-size: 0.8rem;
			font-weight: 600;
			color: var(--text-dim);
			border: 1px solid rgba(255, 255, 255, 0.1);
		}

		/* Overlay Controls for Demo */
		#demo-controls {
			position: absolute;
			bottom: 20px;
			left: 50%;
			transform: translateX(-50%);
			z-index: 10;
			pointer-events: auto;
		}

		.audio-toggle-btn {
			background: rgba(255, 153, 0, 0.2);
			border: 1px solid var(--primary);
			color: #fff;
			padding: 10px 25px;
			border-radius: 30px;
			cursor: pointer;
			font-family: 'Outfit', sans-serif;
			font-weight: 600;
			transition: all 0.3s ease;
		}

		.audio-toggle-btn:hover {
			background: var(--primary);
			color: black;
			box-shadow: 0 0 20px var(--primary-glow);
		}

		/* --- Technical Section --- */
		.section {
			padding: 6rem 2rem;
			max-width: 1200px;
			margin: 0 auto;
			background: var(--dark-bg);
			position: relative;
			z-index: 5;
		}

		.section-title {
			text-align: center;
			font-size: 2.5rem;
			margin-bottom: 4rem;
			font-weight: 700;
		}

		.grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
			gap: 2rem;
		}

		.card {
			background: var(--card-bg);
			padding: 2.5rem;
			border-radius: 24px;
			border: 1px solid rgba(255, 255, 255, 0.05);
			transition: transform 0.3s ease, border-color 0.3s ease;
		}

		.card:hover {
			transform: translateY(-5px);
			border-color: var(--primary);
		}

		.step-num {
			width: 40px;
			height: 40px;
			background: var(--primary);
			color: black;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 800;
			margin-bottom: 1.5rem;
		}

		.card h3 {
			margin-bottom: 1rem;
			font-size: 1.5rem;
		}

		.card p {
			color: var(--text-dim);
			font-size: 1rem;
		}

		/* --- Footer --- */
		footer {
			padding: 4rem 2rem;
			border-top: 1px solid rgba(255, 255, 255, 0.05);
			text-align: center;
			color: var(--text-dim);
			background: var(--dark-bg);
			position: relative;
			z-index: 5;
		}

		.footer-links {
			display: flex;
			gap: 2rem;
			justify-content: center;
			margin-bottom: 2rem;
		}

		.footer-links a {
			color: var(--text-main);
			text-decoration: none;
			font-weight: 600;
			transition: color 0.2s;
		}

		.footer-links a:hover {
			color: var(--primary);
		}

		@media (max-width: 768px) {
			.hero h1 {
				font-size: 2.5rem;
			}

			.hero p {
				font-size: 1.1rem;
			}
		}
	</style>
</head>

<body>

	<section class="hero">
		<div id="visualizer-container"></div>
		<div class="hero-content">
			<span class="hero-emoji">ðŸ•º</span>
			<h1>Reachy Dance Duo</h1>
			<div class="tags">
				<span class="tag">ROBOTICS</span>
				<span class="tag">COMPUTER VISION</span>
				<span class="tag">AUDIO ANALYSIS</span>
				<span class="tag">DANCE</span>
			</div>
			<p>Turn any song into a synchronized dance party with Reachy Mini. Watch the twin visualizer react live to
				the music.</p>
		</div>

		<div id="demo-controls">
			<button id="toggleAudio" class="audio-toggle-btn">
				ðŸ”Š Start Demo Audio
			</button>
		</div>
	</section>

	<section class="section">
		<h2 class="section-title">How it Works</h2>
		<div class="grid">
			<div class="card">
				<div class="step-num">1</div>
				<h3>Connect</h3>
				<p>Launch the app from your Reachy Mini dashboard. The 3D visualizer will automatically link to your
					robot's sensors.</p>
			</div>
			<div class="card">
				<div class="step-num">2</div>
				<h3>Pick a Mode</h3>
				<p>Choose <strong>Live Groove</strong> to dance to ambient sounds via microphone, or <strong>Beat
						Bandit</strong> to choreograph to YouTube tracks.</p>
			</div>
			<div class="card">
				<div class="step-num">3</div>
				<h3>Customize</h3>
				<p>Adjust intensity, amplitude, and safety parameters in real-time. Watch the robots react in the
					visualizer before they move in physical space.</p>
			</div>
			<div class="card">
				<div class="step-num">4</div>
				<h3>Dance!</h3>
				<p>Hit start and watch Reachy Mini perform. The dual-robot kinematics ensure smooth, expressive
					movements synced to every beat.</p>
			</div>
		</div>
	</section>

	<footer>
		<div class="footer-links">
			<a href="https://pollen-robotics.com">Pollen Robotics</a>
			<a href="https://github.com/pollen-robotics/reachy-mini">GitHub</a>
			<a href="https://huggingface.co/pollen-robotics">HF App Store</a>
		</div>
		<p>&copy; 2026 Pollen Robotics. Built for Reachy Mini.</p>
	</footer>

	<audio id="dance-audio" src="dance_duo.wav" crossorigin="anonymous" loop></audio>

	<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

	<script type="module">
		import * as THREE from 'three';
		import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

		// Post-Processing
		import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
		import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
		import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
		import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

		// Custom Modules
		import { ReachyRobot } from './js/ReachyRobot.js';
		import { MusicNoteSystem, SVG3DSystem, getRainbowColor } from './js/Visualizer.js';

		// --- SCENE SETUP ---
		const container = document.getElementById('visualizer-container');
		const scene = new THREE.Scene();
		const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
		camera.position.set(0, 1.5, 4);

		const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
		renderer.setSize(window.innerWidth, window.innerHeight);
		renderer.setPixelRatio(window.devicePixelRatio);
		renderer.setClearColor(0x000000, 1);
		renderer.toneMapping = THREE.ReinhardToneMapping;
		container.appendChild(renderer.domElement);

		// --- POST PROCESSING ---
		const renderScene = new RenderPass(scene, camera);
		const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
		bloomPass.threshold = 1.1;
		bloomPass.strength = 1.5;
		bloomPass.radius = 0.8;
		const outputPass = new OutputPass();

		const composer = new EffectComposer(renderer);
		composer.addPass(renderScene);
		composer.addPass(bloomPass);
		composer.addPass(outputPass);

		const controls = new OrbitControls(camera, renderer.domElement);
		controls.target.set(0, 1, 0);
		controls.update();

		// --- LIGHTING ---
		const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
		scene.add(ambientLight);
		const keyLight = new THREE.DirectionalLight(0xffffff, 2.0);
		keyLight.position.set(5, 10, 7);
		scene.add(keyLight);
		const fillLight = new THREE.DirectionalLight(0xeef2f3, 1.0);
		fillLight.position.set(-5, 5, 5);
		scene.add(fillLight);

		// --- DEEP LOOP VISUALIZER ---
		const columns = 96;
		const panelsTurn = 32;
		const panelsLeg = 32;
		const turnRadius = 25;
		const legLength = 80;
		const turnCenterZ = -50;

		const visualizerGroup = new THREE.Group();
		scene.add(visualizerGroup);
		const blocks = [];
		const panelGeometry = new THREE.PlaneGeometry(2.4, 1.25);

		for (let col = 0; col < columns; col++) {
			const columnBlocks = [];
			let x, z, rotY;

			if (col < panelsLeg) {
				x = -turnRadius;
				const legProgress = (panelsLeg - 1 - col) / panelsLeg;
				z = turnCenterZ + legProgress * legLength;
				rotY = Math.PI / 2;
			} else if (col < panelsLeg + panelsTurn) {
				const turnCol = col - panelsLeg;
				const pct = turnCol / (panelsTurn - 1);
				const angle = Math.PI * (1 - pct);
				x = turnRadius * Math.cos(angle);
				z = turnCenterZ - turnRadius * Math.sin(angle);
				rotY = angle - Math.PI / 2;
			} else {
				const rightCol = col - (panelsLeg + panelsTurn);
				const legProgress = rightCol / panelsLeg;
				x = turnRadius;
				z = turnCenterZ + legProgress * legLength;
				rotY = -Math.PI / 2;
			}

			for (let row = 0; row < 12; row++) {
				const material = new THREE.MeshStandardMaterial({
					color: 0x111111,
					emissive: 0x000000,
					transparent: true,
					opacity: 0.05,
					side: THREE.FrontSide
				});
				const block = new THREE.Mesh(panelGeometry, material);
				block.position.set(x, (row - 6) * 1.28, z);
				block.rotation.y = rotY;
				visualizerGroup.add(block);
				columnBlocks.push({ mesh: block, material: material });
			}
			blocks.push(columnBlocks);
		}
		visualizerGroup.scale.set(0.2, 0.2, 0.2);
		visualizerGroup.position.set(0, 0, -5);

		// --- AUDIO SYSTEM ---
		const audio = document.getElementById('dance-audio');
		const toggleBtn = document.getElementById('toggleAudio');
		let audioContext, analyser, dataArray;
		let audioStarted = false;

		toggleBtn.addEventListener('click', async () => {
			if (!audioContext) {
				audioContext = new (window.AudioContext || window.webkitAudioContext)();
				const source = audioContext.createMediaElementSource(audio);
				analyser = audioContext.createAnalyser();
				analyser.fftSize = 2048;
				source.connect(analyser);
				source.connect(audioContext.destination);
				dataArray = new Uint8Array(analyser.frequencyBinCount);
				audioStarted = true;
			}

			if (audioContext.state === 'suspended') await audioContext.resume();

			if (audio.paused) {
				await audio.play();
				toggleBtn.textContent = 'â¸ Pause Demo Audio';
			} else {
				audio.pause();
				toggleBtn.textContent = 'ðŸ”Š Start Demo Audio';
			}
		});

		// --- GLOBAL ROBOTS ---
		const leftRobot = new ReachyRobot('Left', -0.8, false);
		const rightRobot = new ReachyRobot('Right', 0.8, true);

		let danceData = null;
		let startTime = 0;
		let noteSystem, svgSystem;
		const rowPeaks = Array(12).fill(0).map(() => ({ left: 40.5, right: 54.5 }));

		async function startAnimation() {
			try {
				noteSystem = new MusicNoteSystem(scene);
				svgSystem = new SVG3DSystem(scene);
				// Use a dummy SVG path or correctly link to assets
				svgSystem.load('assets/dance_duo.svg');

				const [danceRes] = await Promise.all([
					fetch('dance_data.json'),
					leftRobot.load('reachy_mini.xml'),
					rightRobot.load('reachy_mini.xml')
				]);

				const data = await danceRes.json();
				danceData = data.frames || data;

				startTime = performance.now();
				requestAnimationFrame(animate);
			} catch (err) {
				console.error("Init Failed", err);
			}
		}

		function animate(time) {
			requestAnimationFrame(animate);

			if (danceData && danceData.length > 0) {
				let currentTime = 0;
				if (audioStarted && !audio.paused) currentTime = audio.currentTime;
				else currentTime = (time - startTime) / 1000;

				const frameIndex = Math.floor(currentTime * 30) % danceData.length;
				const frame = danceData[frameIndex];

				leftRobot.applyPose(frame);
				rightRobot.applyPose(frame);
			}

			// Visualizer Logic
			const bandVolumes = new Array(12).fill(0);
			if (audioStarted && analyser) {
				analyser.getByteFrequencyData(dataArray);
				const binSize = Math.floor(dataArray.length / 12);
				for (let r = 0; r < 12; r++) {
					let sum = 0;
					for (let i = 0; i < binSize; i++) sum += dataArray[r * binSize + i];
					bandVolumes[r] = Math.min((sum / binSize / 255) * 5.0, 1.0);
				}
			}

			if (noteSystem) noteSystem.update(0.016);
			if (svgSystem) svgSystem.update(0.016);

			// Deep Loop Update
			const mapping = [11, 9, 7, 5, 3, 1, 0, 2, 4, 6, 8, 10];
			const centerCol = 47.5;
			const maxHalfWidth = 48;

			for (let r = 0; r < 12; r++) {
				const vol = bandVolumes[mapping[r]] || 0;
				const halfW = 7 + (vol * 41);
				const start = Math.floor(centerCol - halfW);
				const end = Math.ceil(centerCol + halfW);

				if (rowPeaks[r].left > start) rowPeaks[r].left -= 1.0;
				else rowPeaks[r].left = start;
				if (rowPeaks[r].right < end) rowPeaks[r].right += 1.0;
				else rowPeaks[r].right = end;

				for (let c = 0; c < columns; c++) {
					const blockData = blocks[c][r];
					let isLit = (c >= start && c <= end);
					let isLeader = (c === Math.floor(rowPeaks[r].left) || c === Math.floor(rowPeaks[r].right));

					if (isLit || isLeader) {
						blockData.material.opacity = 0.9;
						blockData.material.emissive.copy(getRainbowColor((c - start) / (end - start || 1)));
						blockData.material.emissiveIntensity = isLeader ? 0.95 : 0.8;
					} else {
						blockData.material.opacity = 0.05;
						blockData.material.emissiveIntensity = 0;
					}
				}
			}

			composer.render();
		}

		window.addEventListener('resize', () => {
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
			renderer.setSize(window.innerWidth, window.innerHeight);
			composer.setSize(window.innerWidth, window.innerHeight);
		});

		startAnimation();
	</script>
</body>

</html>