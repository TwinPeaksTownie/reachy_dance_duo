<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Reachy Dance Duo - Pollen Robotics</title>
	<link rel="preconnect" href="https://fonts.googleapis.com">
	<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
	<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap"
		rel="stylesheet">
	<style>
		:root {
			--primary: #FF9900;
			--primary-glow: rgba(255, 153, 0, 0.4);
			--dark-bg: #0A0A0A;
			--card-bg: #141414;
			--text-main: #FFFFFF;
			--text-dim: #A0A0A0;
			--accent-blue: #00D1FF;
		}

		* {
			box-sizing: border-box;
			margin: 0;
			padding: 0;
		}

		body {
			font-family: 'Outfit', sans-serif;
			background-color: var(--dark-bg);
			color: var(--text-main);
			line-height: 1.6;
			overflow-x: hidden;
		}

		/* --- Hero Section & 3D Canvas --- */
		.hero {
			position: relative;
			height: 80vh;
			display: flex;
			align-items: center;
			justify-content: center;
			text-align: center;
			padding: 2rem;
			overflow: hidden;
		}

		#visualizer-container {
			position: absolute;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			z-index: 0;
			opacity: 1.0;
		}

		.hero-content {
			max-width: 800px;
			z-index: 1;
			pointer-events: none;
			/* Allow interaction with canvas below if needed */
		}

		.hero-emoji {
			font-size: 4rem;
			margin-bottom: 1rem;
			display: block;
			animation: bounce 2s infinite;
		}

		@keyframes bounce {

			0%,
			100% {
				transform: translateY(0);
			}

			50% {
				transform: translateY(-10px);
			}
		}

		.hero h1 {
			font-size: 4rem;
			font-weight: 800;
			margin-bottom: 1rem;
			background: linear-gradient(90deg, #FFFFFF, var(--primary));
			-webkit-background-clip: text;
			background-clip: text;
			-webkit-text-fill-color: transparent;
			letter-spacing: -1px;
		}

		.hero p {
			font-size: 1.5rem;
			color: var(--text-dim);
			margin-bottom: 2rem;
			font-weight: 300;
		}

		.tags {
			display: flex;
			gap: 0.5rem;
			justify-content: center;
			flex-wrap: wrap;
			margin-bottom: 2rem;
		}

		.tag {
			background: rgba(255, 255, 255, 0.1);
			padding: 0.4rem 1rem;
			border-radius: 20px;
			font-size: 0.8rem;
			font-weight: 600;
			color: var(--text-dim);
			border: 1px solid rgba(255, 255, 255, 0.1);
		}

		/* Overlay Controls for Demo */
		#demo-controls {
			position: absolute;
			bottom: 20px;
			left: 50%;
			transform: translateX(-50%);
			z-index: 10;
			pointer-events: auto;
		}

		.audio-toggle-btn {
			background: rgba(255, 153, 0, 0.2);
			border: 1px solid var(--primary);
			color: #fff;
			padding: 10px 25px;
			border-radius: 30px;
			cursor: pointer;
			font-family: 'Outfit', sans-serif;
			font-weight: 600;
			transition: all 0.3s ease;
		}

		.audio-toggle-btn:hover {
			background: var(--primary);
			color: black;
			box-shadow: 0 0 20px var(--primary-glow);
		}

		/* --- Technical Section --- */
		.section {
			padding: 6rem 2rem;
			max-width: 1200px;
			margin: 0 auto;
			background: var(--dark-bg);
			position: relative;
			z-index: 5;
		}

		.section-title {
			text-align: center;
			font-size: 2.5rem;
			margin-bottom: 4rem;
			font-weight: 700;
		}

		.grid {
			display: grid;
			grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
			gap: 2rem;
		}

		.card {
			background: var(--card-bg);
			padding: 2.5rem;
			border-radius: 24px;
			border: 1px solid rgba(255, 255, 255, 0.05);
			transition: transform 0.3s ease, border-color 0.3s ease;
		}

		.card:hover {
			transform: translateY(-5px);
			border-color: var(--primary);
		}

		.step-num {
			width: 40px;
			height: 40px;
			background: var(--primary);
			color: black;
			border-radius: 50%;
			display: flex;
			align-items: center;
			justify-content: center;
			font-weight: 800;
			margin-bottom: 1.5rem;
		}

		.card h3 {
			margin-bottom: 1rem;
			font-size: 1.5rem;
		}

		.card p {
			color: var(--text-dim);
			font-size: 1rem;
		}

		/* --- Footer --- */
		footer {
			padding: 4rem 2rem;
			border-top: 1px solid rgba(255, 255, 255, 0.05);
			text-align: center;
			color: var(--text-dim);
			background: var(--dark-bg);
			position: relative;
			z-index: 5;
		}

		.footer-links {
			display: flex;
			gap: 2rem;
			justify-content: center;
			margin-bottom: 2rem;
		}

		.footer-links a {
			color: var(--text-main);
			text-decoration: none;
			font-weight: 600;
			transition: color 0.2s;
		}

		.footer-links a:hover {
			color: var(--primary);
		}

		@media (max-width: 768px) {
			.hero h1 {
				font-size: 2.5rem;
			}

			.hero p {
				font-size: 1.1rem;
			}
		}

		/* --- REPLACED EDITOR UI STYLES --- */
		#builder-panel {
			position: absolute;
			top: 20px;
			right: 20px;
			width: 220px;
			background: rgba(0, 20, 20, 0.9);
			border: 1px solid #0ff;
			color: #0ff;
			padding: 15px;
			border-radius: 8px;
			font-family: 'Outfit', sans-serif;
			box-shadow: 0 0 20px rgba(0, 255, 255, 0.2);
			z-index: 1001;
		}

		#builder-panel.hidden {
			display: none;
		}

		#builder-panel h3 {
			margin-top: 0;
			color: #fff;
			text-transform: uppercase;
			font-size: 0.9em;
			border-bottom: 1px solid #0ff;
			padding-bottom: 5px;
		}

		.coord-row {
			display: flex;
			justify-content: space-between;
			margin: 5px 0;
			align-items: center;
		}

		.coord-divider {
			border-bottom: 1px solid #444;
			margin: 10px 0 5px;
			font-size: 0.8em;
			color: #888;
		}

		.slide-row label {
			width: 20px;
		}

		.slide-row input {
			width: 70px;
			margin: 0 2px;
		}

		.slide-val {
			font-size: 0.8em;
			color: #fff;
			width: 35px;
			text-align: right;
		}

		.nudge-btn {
			width: 24px;
			height: 24px;
			border: 1px solid #0ff;
			background: rgba(0, 40, 40, 0.5);
			color: #0ff;
			cursor: pointer;
			font-size: 16px;
			display: flex;
			align-items: center;
			justify-content: center;
			border-radius: 4px;
		}

		.nudge-btn:hover {
			background: #0ff;
			color: #000;
		}

		.tools-row {
			display: flex;
			gap: 5px;
			margin: 10px 0;
		}

		.tool-btn {
			flex: 1;
			background: #222;
			border: 1px solid #0ff;
			color: #0ff;
			cursor: pointer;
			padding: 6px;
			font-size: 0.8em;
		}

		.tool-btn.active {
			background: #0ff;
			color: #000;
		}

		.action-btn {
			width: 100%;
			background: #0ff;
			color: #000;
			border: none;
			padding: 10px;
			cursor: pointer;
			font-weight: bold;
			margin-top: 5px;
			text-transform: uppercase;
			font-size: 0.8rem;
		}

		.action-btn:hover {
			background: #fff;
		}

		.action-btn.secondary {
			background: transparent;
			border: 1px solid #0ff;
			color: #0ff;
		}

		#btn-builder-toggle {
			position: fixed;
			bottom: 30px;
			right: 30px;
			background: rgba(0, 0, 0, 0.7);
			border: 1px solid #0ff;
			border-radius: 50%;
			width: 50px;
			height: 50px;
			font-size: 24px;
			cursor: pointer;
			z-index: 1000;
			transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
			color: #0ff;
		}

		#btn-builder-toggle:hover {
			background: #0ff;
			color: #000;
			box-shadow: 0 0 25px #0ff;
			transform: scale(1.15) rotate(15deg);
		}

		#svg-panel {
			position: absolute;
			top: 20px;
			right: 20px;
			width: 280px;
			background: rgba(0, 0, 0, 0.85);
			backdrop-filter: blur(12px);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: 12px;
			padding: 20px;
			color: white;
			font-family: 'Outfit', sans-serif;
			z-index: 1002;
			box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
		}

		#svg-panel h3 {
			margin: 0 0 15px 0;
			font-size: 14px;
			text-transform: uppercase;
			letter-spacing: 2px;
			color: #FF9900;
		}

		.control-group {
			margin-bottom: 14px;
			display: flex;
			align-items: center;
			justify-content: space-between;
		}

		.control-group label {
			font-size: 12px;
			color: #bbb;
			font-weight: 500;
		}

		.control-group input[type="range"] {
			width: 60%;
			accent-color: #FF9900;
		}

		.control-group input[type="color"] {
			border: 1px solid #444;
			width: 45px;
			height: 28px;
			background: #222;
			cursor: pointer;
			border-radius: 4px;
		}
	</style>
</head>

<body>

	<section class="hero">
		<div id="visualizer-container"></div>

		<!-- UI PANELS FOR AESTHETIC FINE-TUNING -->
		<div id="builder-panel" class="hidden">
			<h3>Placement Mode</h3>
			<p>Selected: <span id="builder-target">None</span></p>
			<div class="coord-row"><label>X:</label> <span id="val-x">0.00</span></div>
			<div class="coord-row"><label>Y:</label> <span id="val-y">0.00</span></div>
			<div class="coord-row"><label>Z:</label> <span id="val-z">0.00</span></div>
			<div class="coord-divider">ROTATION (Deg)</div>
			<div class="coord-row slide-row">
				<label>X:</label>
				<input type="range" id="rot-x" min="-180" max="180" step="1">
				<span id="disp-rot-x" class="slide-val">0</span>
			</div>
			<div class="coord-row slide-row">
				<label>Y:</label>
				<input type="range" id="rot-y" min="-180" max="180" step="1">
				<span id="disp-rot-y" class="slide-val">0</span>
			</div>
			<button id="btn-lock" class="action-btn">üîí Lock Position</button>
			<button id="btn-cancel" class="action-btn secondary">Cancel</button>
			<div class="coord-divider">CAMERA POV</div>
			<div class="coord-row"><label>Pos:</label> <span id="cam-pos">0, 0, 0</span></div>
			<div class="coord-row"><label>Rot:</label> <span id="cam-rot">0, 0, 0</span></div>
		</div>

		<button id="btn-builder-toggle" title="Enter Placement Mode">üõ†Ô∏è</button>

		<div id="svg-panel" style="display: none;">
			<h3>Logo Editor</h3>
			<div class="control-group"><label>Scale</label><input type="range" id="svg-scale" min="0.0005" max="0.005"
					step="0.0001" value="0.0037"></div>
			<div class="control-group"><label>Color</label><input type="color" id="svg-color" value="#f7cf02"></div>
			<div class="control-group"><label>Glow</label><input type="range" id="svg-glow" min="0" max="5" step="0.1"
					value="1.8"></div>
			<div class="control-group"><label>Bloom Radius</label><input type="range" id="bloom-radius" min="0" max="2"
					step="0.01" value="0.39"></div>
			<div class="control-group"><label>Bloom Strength</label><input type="range" id="bloom-strength" min="0"
					max="5" step="0.1" value="0.3"></div>
			<div class="control-group"><label>Bloom Threshold</label><input type="range" id="bloom-threshold" min="0"
					max="2.0" step="0.1" value="1.5"></div>
			<div class="control-group"><label>Tilt</label><input type="range" id="svg-tilt" min="-0.2" max="0.2"
					step="0.001" value="0.041"></div>
			<div class="control-group"><label>Depth (Z)</label><input type="range" id="svg-z" min="-50" max="100"
					step="0.1" value="-4.5"></div>
			<div class="control-group"><label>Offset Y</label><input type="range" id="svg-y" min="0" max="3" step="0.1"
					value="1.4"></div>
			<div class="control-group"><label>Drift</label><input type="range" id="drift-speed" min="0" max="2"
					step="0.1" value="0.4"></div>
			<div class="control-group"><label>Beam Pos Y</label><input type="range" id="red-beam" min="0" max="1"
					step="0.01" value="0.35"></div>
			<div class="control-group"><label>Beam Feather</label><input type="range" id="beam-feather" min="0" max="1"
					step="0.01" value="0.8"></div>
			<button id="btn-save-svg" class="action-btn">üíæ Save Config (Persistent)</button>
		</div>

		<div id="demo-controls">
			<button id="toggleAudio" class="audio-toggle-btn">
				üîä Start Demo Audio
			</button>
		</div>
	</section>

	<section class="section">
		<h2 class="section-title">How it Works</h2>
		<div class="grid">
			<div class="card">
				<div class="step-num">1</div>
				<h3>Connect</h3>
				<p>Launch the app from your Reachy Mini dashboard. The 3D visualizer will automatically link to your
					robot's sensors.</p>
			</div>
			<div class="card">
				<div class="step-num">2</div>
				<h3>Pick a Mode</h3>
				<p>Choose <strong>Live Groove</strong> to dance to ambient sounds via microphone, or <strong>Beat
						Bandit</strong> to choreograph to YouTube tracks.</p>
			</div>
			<div class="card">
				<div class="step-num">3</div>
				<h3>Customize</h3>
				<p>Adjust intensity, amplitude, and safety parameters in real-time. Watch the robots react in the
					visualizer before they move in physical space.</p>
			</div>
			<div class="card">
				<div class="step-num">4</div>
				<h3>Dance!</h3>
				<p>Hit start and watch Reachy Mini perform. The dual-robot kinematics ensure smooth, expressive
					movements synced to every beat.</p>
			</div>
		</div>
	</section>

	<footer>
		<div class="footer-links">
			<a href="https://pollen-robotics.com">Pollen Robotics</a>
			<a href="https://github.com/pollen-robotics/reachy-mini">GitHub</a>
			<a href="https://huggingface.co/pollen-robotics">HF App Store</a>
		</div>
		<p>&copy; 2026 Pollen Robotics. Built for Reachy Mini.</p>
	</footer>

	<audio id="dance-audio" src="dance_duo.wav" crossorigin="anonymous" loop></audio>

	<script type="importmap">
    {
        "imports": {
            "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
            "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
        }
    }
    </script>

	<script type="module">
		import * as THREE from 'three';
		import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

		// Post-Processing
		import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
		import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
		import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';
		import { OutputPass } from 'three/addons/postprocessing/OutputPass.js';

		// Custom Modules
		import { ReachyRobot } from './js/reachy_robot.js';
		import { MusicNoteSystem, SVG3DSystem, getRainbowColor } from './js/visualizer.js';

		// --- SCENE SETUP ---
		const container = document.getElementById('visualizer-container');
		const scene = new THREE.Scene();
		const camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 0.1, 1000);
		camera.position.set(0.06650214614867994, -0.5509992498139562, 3.885498842512818);

		const renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
		renderer.setSize(window.innerWidth, window.innerHeight);
		renderer.setPixelRatio(window.devicePixelRatio);
		renderer.setClearColor(0x000000, 1);
		renderer.toneMapping = THREE.ReinhardToneMapping;
		container.appendChild(renderer.domElement);

		// --- POST PROCESSING ---
		const renderScene = new RenderPass(scene, camera);
		const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
		bloomPass.threshold = 1.5; // Definitive threshold
		bloomPass.strength = 0.3;  // Definitive strength
		bloomPass.radius = 0.39;  // Definitive radius
		const outputPass = new OutputPass();

		const composer = new EffectComposer(renderer);
		composer.addPass(renderScene);
		composer.addPass(bloomPass);
		composer.addPass(outputPass);

		const controls = new OrbitControls(camera, renderer.domElement);
		controls.target.set(0.22978033215455446, -0.23017558883193248, 0.0037882423081313974);
		controls.update();

		// --- LIGHTING ---
		const ambientLight = new THREE.AmbientLight(0xffffff, 0.4);
		scene.add(ambientLight);

		const keyLight = new THREE.DirectionalLight(0xffffff, 2.0);
		keyLight.position.set(5, 10, 7);
		scene.add(keyLight);

		const fillLight = new THREE.DirectionalLight(0xeef2f3, 1.0);
		fillLight.position.set(-5, 5, 5);
		scene.add(fillLight);

		const rimLight = new THREE.PointLight(0xffffff, 2.0);
		rimLight.position.set(0, 10, -10);
		scene.add(rimLight);

		// Ring Light Array for premium reflections
		const ringRadius = 5;
		const ringZ = 15;
		const ringCount = 8;
		for (let i = 0; i < ringCount; i++) {
			const angle = (i / ringCount) * Math.PI * 2;
			const ringLight = new THREE.PointLight(0xffffff, 0.8, 50);
			ringLight.position.set(Math.cos(angle) * ringRadius, Math.sin(angle) * ringRadius, ringZ);
			scene.add(ringLight);
		}


		// --- 3D TITLE CARD SYSTEM (Hero Visuals) ---
		const svgSystem = new SVG3DSystem(scene);
		svgSystem.load('assets/dance_duo.svg');

		// Floating Notes
		const noteSystem = new MusicNoteSystem(scene);


		// --- RAINBOW VISUALIZER (Deep Loop) ---
		const columns = 96;
		const panelsTurn = 32;
		const panelsLeg = 32;
		const turnRadius = 25;
		const legLength = 80;
		const turnCenterZ = -50;

		const visualizerGroup = new THREE.Group();
		scene.add(visualizerGroup);
		const blocks = [];
		const panelGeometry = new THREE.PlaneGeometry(2.4, 1.25);

		for (let col = 0; col < columns; col++) {
			const columnBlocks = [];
			let x, z, rotY;

			if (col < panelsLeg) {
				x = -turnRadius;
				const legProgress = (panelsLeg - 1 - col) / panelsLeg;
				z = turnCenterZ + legProgress * legLength;
				rotY = Math.PI / 2;
			} else if (col < panelsLeg + panelsTurn) {
				const turnCol = col - panelsLeg;
				const pct = turnCol / (panelsTurn - 1);
				const angle = Math.PI * (1 - pct);
				x = turnRadius * Math.cos(angle);
				z = turnCenterZ - turnRadius * Math.sin(angle);
				rotY = angle - Math.PI / 2;
			} else {
				const rightCol = col - (panelsLeg + panelsTurn);
				const legProgress = rightCol / panelsLeg;
				x = turnRadius;
				z = turnCenterZ + legProgress * legLength;
				rotY = -Math.PI / 2;
			}

			for (let row = 0; row < 12; row++) {
				const material = new THREE.MeshStandardMaterial({
					color: 0x111111,
					emissive: 0x000000,
					transparent: true,
					opacity: 0.05,
					side: THREE.FrontSide
				});
				const block = new THREE.Mesh(panelGeometry, material);
				block.position.set(x, (row - 6) * 1.28, z);
				block.rotation.y = rotY;
				visualizerGroup.add(block);
				columnBlocks.push({ mesh: block, material: material });
			}
			blocks.push(columnBlocks);
		}
		visualizerGroup.scale.set(0.2, 0.2, 0.2);
		visualizerGroup.position.set(0, 0, -5);

		// Row peaks for smooth animation (start with initial spread)
		const rowPeaks = Array.from({ length: 12 }, () => ({ left: 40.5, right: 54.5 }));
		const centerCol = 47.5;
		// Symmetric mapping - outer edges share frequencies for mirror effect
		const mapping = [11, 9, 7, 5, 3, 1, 0, 2, 4, 6, 8, 10];

		// --- AUDIO SYSTEM ---
		const audio = document.getElementById('dance-audio');
		const toggleBtn = document.getElementById('toggleAudio');
		let audioContext, analyser, dataArray;
		let audioStarted = false;

		toggleBtn.addEventListener('click', async () => {
			if (!audioContext) {
				audioContext = new (window.AudioContext || window.webkitAudioContext)();
				const source = audioContext.createMediaElementSource(audio);
				analyser = audioContext.createAnalyser();
				analyser.fftSize = 2048;
				source.connect(analyser);
				source.connect(audioContext.destination);
				dataArray = new Uint8Array(analyser.frequencyBinCount);
				audioStarted = true;
			}

			if (audioContext.state === 'suspended') await audioContext.resume();

			if (audio.paused) {
				await audio.play();
				toggleBtn.textContent = '‚è∏ Pause Demo Audio';
			} else {
				audio.pause();
				toggleBtn.textContent = 'üîä Start Demo Audio';
			}
		});

		// --- GLOBAL ROBOTS ---
		const leftRobot = new ReachyRobot('Left', 0, false);
		const rightRobot = new ReachyRobot('Right', 0, true);

		let danceData = null;
		let startTime = 0;


		async function startAnimation() {
			try {
				const [danceRes] = await Promise.all([
					fetch('dance_data.json'),
					leftRobot.load('reachy_mini.xml'),
					rightRobot.load('reachy_mini.xml')
				]);

				// Added robots to scene after loading
				scene.add(leftRobot.group);
				scene.add(rightRobot.group);

				// APPLY ROBOT CONFIG FROM TEST2 (HARDCODED FOR STATIC)
				leftRobot.group.position.set(-0.8786421648527453, -1.45, -1);
				leftRobot.group.rotation.set(-1.5707963057214724, -1.0821041362364838, 0);

				rightRobot.group.position.set(0.8058102035783206, -1.45, -0.7084707284386818);
				rightRobot.group.rotation.set(-1.5707963267948966, -2.0769418098732526, 0);

				const data = await danceRes.json();
				danceData = data.frames || data;

				startTime = performance.now();
				requestAnimationFrame(animate);
			} catch (err) {
				console.error("Init Failed", err);
			}
		}

		function animate(time) {
			requestAnimationFrame(animate);

			if (danceData && danceData.length > 0) {
				let currentTime = 0;
				if (audioStarted && !audio.paused) currentTime = audio.currentTime;
				else currentTime = (time - startTime) / 1000;

				const frameIndex = Math.floor(currentTime * 30) % danceData.length;
				const frame = danceData[frameIndex];

				leftRobot.applyPose(frame);
				rightRobot.applyPose(frame);
			}

			// Visualizer Logic - Rainbow Blocks
			const bandVolumes = new Array(12).fill(0);
			if (audioStarted && analyser) {
				analyser.getByteFrequencyData(dataArray);

				// Volume compensation - adjust for audio volume slider
				const vol = Math.max(audio.volume, 0.05);
				const compensation = 1.0 / vol;

				const binSize = Math.floor(dataArray.length / 12);
				for (let r = 0; r < 12; r++) {
					let sum = 0;
					for (let i = 0; i < binSize; i++) sum += dataArray[r * binSize + i];
					let rawVal = (sum / binSize) / 255;
					// Boost signal then apply volume compensation
					bandVolumes[r] = Math.min(rawVal * 1.6 * compensation, 1.0);
				}

				// Bass dampening - prevent bass from overpowering
				bandVolumes[0] *= 0.6;
				bandVolumes[1] *= 0.7;
				bandVolumes[2] *= 0.8;
			}

			// Update rainbow blocks
			for (let r = 0; r < 12; r++) {
				const rowVol = bandVolumes[mapping[r]] || 0;
				const halfW = 7 + (rowVol * 41);
				const start = Math.floor(centerCol - halfW);
				const end = Math.ceil(centerCol + halfW);

				// Smooth peak tracking
				if (rowPeaks[r].left > start) rowPeaks[r].left -= 1.0;
				if (rowPeaks[r].left < start) rowPeaks[r].left = start;
				if (rowPeaks[r].right < end) rowPeaks[r].right += 1.0;
				if (rowPeaks[r].right > end) rowPeaks[r].right = end;

				for (let c = 0; c < columns; c++) {
					const blockData = blocks[c][r];
					let isLit = (c >= start && c <= end);
					let isLeader = (c === Math.floor(rowPeaks[r].left) || c === Math.floor(rowPeaks[r].right));
					const colorScalar = (c - start) / (end - start || 1);

					if (isLit || isLeader) {
						blockData.material.opacity = 0.9;
						blockData.material.emissive.copy(getRainbowColor(colorScalar));
						// Dynamic intensity based on volume, capped below bloom threshold
						const rawIntensity = 0.8 + (rowVol * 0.5);
						blockData.material.emissiveIntensity = isLeader ? 0.95 : Math.min(rawIntensity, 0.9);
					} else {
						blockData.material.opacity = 0.05;
						blockData.material.emissiveIntensity = 0;
						blockData.material.emissive.setHex(0x000000);
					}
				}
			}

			if (noteSystem) noteSystem.update(0.016);
			if (svgSystem) svgSystem.update(0.016);

			composer.render();
		}

		window.addEventListener('resize', () => {
			camera.aspect = window.innerWidth / window.innerHeight;
			camera.updateProjectionMatrix();
			renderer.setSize(window.innerWidth, window.innerHeight);
			composer.setSize(window.innerWidth, window.innerHeight);
		});

		// --- SVG EDITOR LOGIC ---
		function setupSVGEditor() {
			const scaleInput = document.getElementById('svg-scale');
			const colorInput = document.getElementById('svg-color');
			const glowInput = document.getElementById('svg-glow');
			const radiusInput = document.getElementById('bloom-radius');
			const strengthInput = document.getElementById('bloom-strength');
			const thresholdInput = document.getElementById('bloom-threshold');
			const tiltInput = document.getElementById('svg-tilt');
			const zInput = document.getElementById('svg-z');
			const yInput = document.getElementById('svg-y');
			const driftInput = document.getElementById('drift-speed');
			const redBeamInput = document.getElementById('red-beam');
			const beamFeatherInput = document.getElementById('beam-feather');
			const saveBtn = document.getElementById('btn-save-svg');
			const toggleBtn = document.getElementById('btn-builder-toggle');
			const panel = document.getElementById('svg-panel');

			toggleBtn.addEventListener('click', () => {
				panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
			});

			function updateSVG() {
				if (!bloomPass) return;
				bloomPass.radius = parseFloat(radiusInput.value);
				bloomPass.strength = parseFloat(strengthInput.value);
				bloomPass.threshold = parseFloat(thresholdInput.value);

				if (!svgSystem || !svgSystem.loadedMesh || !svgSystem.config) return;

				svgSystem.config.z = parseFloat(zInput.value);
				svgSystem.config.y = parseFloat(yInput.value);
				svgSystem.config.drift = parseFloat(driftInput.value);
				svgSystem.config.redBeam = parseFloat(redBeamInput.value);
				svgSystem.config.beamFeather = parseFloat(beamFeatherInput.value);

				svgSystem.loadedMesh.scale.setScalar(parseFloat(scaleInput.value));
				svgSystem.loadedMesh.rotation.z = parseFloat(tiltInput.value);

				svgSystem.updateTexture(colorInput.value, svgSystem.config.redBeam, svgSystem.config.beamFeather);

				const glow = parseFloat(glowInput.value);
				svgSystem.loadedMesh.traverse(node => {
					if (node.isPointLight) node.intensity = glow * 6;
					if (node.isMesh && node.name === "CoreLetter") node.material.emissiveIntensity = glow;
				});
			}

			[scaleInput, colorInput, glowInput, radiusInput, strengthInput, thresholdInput, tiltInput, zInput, yInput, driftInput, redBeamInput, beamFeatherInput].forEach(el => {
				el.addEventListener('input', updateSVG);
			});

			saveBtn.addEventListener('click', () => {
				const config = {
					scale: scaleInput.value, color: colorInput.value, glow: glowInput.value,
					radius: radiusInput.value, strength: strengthInput.value, threshold: thresholdInput.value,
					tilt: tiltInput.value, z: zInput.value, y: yInput.value, drift: driftInput.value,
					redBeam: redBeamInput.value, beamFeather: beamFeatherInput.value
				};
				localStorage.setItem('svgConfig', JSON.stringify(config));
				alert("Aesthetic configuration saved!");
			});

			window.addEventListener('svg-loaded', () => setTimeout(updateSVG, 100));
		}

		setupSVGEditor();
		startAnimation();
	</script>
</body>

</html>